#!/etc/init.d/rc.sh /etc/rc.common

START=95
USE_PROCD=1

prepare_instance() {
    local section="$1"
    local enabled path ratio qid name
    config_get_bool enabled "$section" enabled 0
    [ "$enabled" -eq 0 ] && return

    config_get name "$section" name "Group_$section"
    config_get path "$section" path
    config_get ratio "$section" ratio "1.0"
    config_get qid "$section" queue "10"

    [ ! -f "$path" ] && return

    # 只处理 Ratio > 0 的实例
    if [ "$(awk "BEGIN {print ($ratio > 0)}")" -eq 1 ]; then
        # 核心：使用 inet 族规则同时引流 IPv4 和 IPv6 新连接
        # 注意：这里分别显式添加 ip 和 ip6 规则确保内核准确识别
        nft add rule inet fence_table filter_chain ip daddr != 0.0.0.0/0 ct state new queue num "$qid"
        nft add rule inet fence_table filter_chain ip6 daddr != ::/0 ct state new queue num "$qid"
        
        CONF_ARGS="$CONF_ARGS $name:$qid:$ratio:$path"
    fi
}

start_service() {
    config_load fence
    CONF_ARGS=""
    
    # 初始化防护表
    nft add table inet fence_table
    nft add chain inet fence_table filter_chain { type filter hook forward priority 0 \; }

    config_foreach prepare_instance database

    if [ -n "$CONF_ARGS" ]; then
        procd_open_instance
        procd_set_param command /usr/bin/fence-daemon $CONF_ARGS
        procd_set_param respawn
        procd_set_param stderr 1
        procd_close_instance
    fi
}

stop_service() {
    nft delete table inet fence_table 2>/dev/null
}
