#!/etc/init.d/rc.sh /etc/rc.common

START=95
USE_PROCD=1

# 全局计数器，起始 ID 设为 1000（避开系统可能的低位占用）
Q_INDEX=1000

prepare_instance() {
    local section="$1"
    local enabled path ratio name
    config_get_bool enabled "$section" enabled 0
    [ "$enabled" -eq 0 ] && return

    config_get name "$section" name "Group_$section"
    config_get path "$section" path
    config_get ratio "$section" ratio "1.0"

    [ ! -f "$path" ] && return

    # 使用当前的 Q_INDEX 作为 queue_id
    local current_qid=$Q_INDEX
    
    nft add rule inet fence_table filter_chain ip daddr != 0.0.0.0/0 ct state new queue num "$current_qid"
    nft add rule inet fence_table filter_chain ip6 daddr != ::/0 ct state new queue num "$current_qid"
    
    CONF_ARGS="$CONF_ARGS $name:$current_qid:$ratio:$path"
    
    # 索引递增，确保下一个库使用不同的 ID
    Q_INDEX=$((Q_INDEX + 1))
}

start_service() {
    config_load fence
    CONF_ARGS=""
    Q_INDEX=10 # 重置计数器
    
    nft add table inet fence_table
    nft add chain inet fence_table filter_chain { type filter hook forward priority 0 \; }

    config_foreach prepare_instance database

    if [ -n "$CONF_ARGS" ]; then
        procd_open_instance
        procd_set_param command /usr/bin/fence-daemon $CONF_ARGS
        procd_set_param respawn
        procd_close_instance
    fi
}

stop_service() {
    nft delete table inet fence_table 2>/dev/null
}
